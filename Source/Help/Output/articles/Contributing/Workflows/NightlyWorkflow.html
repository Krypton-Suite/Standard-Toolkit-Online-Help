<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>Nightly Workflow | Krypton Standard Toolkit Documentation </title>
      <meta name="viewport" content="width=device-width">
      <meta name="title" content="Nightly Workflow | Krypton Standard Toolkit Documentation ">
    
    
      <link rel="shortcut icon" href="../../../Krypton.ico">
      <link rel="stylesheet" href="../../../styles/docfx.vendor.min.css">
      <link rel="stylesheet" href="../../../styles/docfx.css">
      <link rel="stylesheet" href="../../../styles/main.css">
      <meta property="docfx:navrel" content="../../../toc.html">
      <meta property="docfx:tocrel" content="../../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../../../index.html">
                <img id="logo" class="svg" src="../../../Logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="nightly-workflow">Nightly Workflow</h1>

<h2 id="overview">Overview</h2>
<p>The Nightly workflow automatically creates and publishes bleeding-edge builds from the <code>alpha</code> branch on a daily schedule. It includes intelligent change detection to skip builds when no changes have occurred, and features kill switch controls for emergency disabling.</p>
<h2 id="purpose">Purpose</h2>
<ul>
<li><strong>Automated Nightly Builds</strong>: Provides latest development builds without manual intervention</li>
<li><strong>Change Detection</strong>: Only builds when code has changed in the last 24 hours</li>
<li><strong>Bleeding-Edge Testing</strong>: Enables early testing of new features and fixes</li>
<li><strong>NuGet Publishing</strong>: Automatically publishes packages to nuget.org</li>
<li><strong>Community Notifications</strong>: Announces releases via Discord</li>
</ul>
<h2 id="trigger-conditions">Trigger Conditions</h2>
<h3 id="scheduled">Scheduled</h3>
<ul>
<li><strong>Cron</strong>: <code>0 0 * * *</code> (midnight UTC every day)</li>
<li><strong>Time Zone</strong>: UTC</li>
<li><strong>Frequency</strong>: Once per day</li>
</ul>
<h3 id="manual">Manual</h3>
<ul>
<li><strong><code>workflow_dispatch</code></strong>: Can be manually triggered from Actions tab</li>
<li><strong>Use Case</strong>: Testing workflow changes or forcing a build</li>
</ul>
<h2 id="workflow-structure">Workflow Structure</h2>
<h3 id="job-nightly">Job: <code>nightly</code></h3>
<p><strong>Runner</strong>: <code>windows-latest</code></p>
<p><strong>Environment</strong>: <code>production</code> (requires approval before publishing)</p>
<p><strong>Concurrency</strong>:</p>
<ul>
<li><strong>Group</strong>: <code>nightly-alpha</code></li>
<li><strong>Cancel In-Progress</strong>: <code>true</code></li>
<li>Prevents multiple nightly builds from running simultaneously</li>
</ul>
<h3 id="steps-overview">Steps Overview</h3>
<ol>
<li><strong>Kill Switch Check</strong> - Verifies if workflow is disabled</li>
<li><strong>Security Verification</strong> - Validates repository and branch</li>
<li><strong>Checkout</strong> - Checks out <code>alpha</code> branch</li>
<li><strong>Change Detection</strong> - Checks for commits in last 24 hours</li>
<li><strong>Skip Notification</strong> - Notifies if no changes found</li>
<li><strong>Setup .NET</strong> - Installs .NET SDKs</li>
<li><strong>Setup .NET 11</strong> - Attempts to install .NET 11 (optional)</li>
<li><strong>Force .NET 10 SDK</strong> - Creates <code>global.json</code></li>
<li><strong>Setup MSBuild</strong> - Configures MSBuild</li>
<li><strong>Setup NuGet</strong> - Configures NuGet</li>
<li><strong>Cache NuGet</strong> - Caches packages</li>
<li><strong>Restore</strong> - Restores dependencies</li>
<li><strong>Build Nightly</strong> - Builds the solution</li>
<li><strong>Pack Nightly</strong> - Creates NuGet packages</li>
<li><strong>Push NuGet Packages</strong> - Publishes to nuget.org</li>
<li><strong>Get Version</strong> - Extracts version information</li>
<li><strong>Announce on Discord</strong> - Sends notification</li>
</ol>
<h2 id="detailed-behavior">Detailed Behavior</h2>
<h3 id="kill-switch">Kill Switch</h3>
<p><strong>Variable</strong>: <code>NIGHTLY_DISABLED</code></p>
<p><strong>Location</strong>: Repository Settings â†’ Secrets and variables â†’ Actions â†’ Variables</p>
<p><strong>Values</strong>:</p>
<ul>
<li><code>true</code> - Disables workflow (all steps skipped after check)</li>
<li><code>false</code> or unset - Enables workflow</li>
</ul>
<p><strong>Use Cases</strong>:</p>
<ul>
<li>Emergency disabling of automated builds</li>
<li>Maintenance periods</li>
<li>Preventing duplicate releases</li>
</ul>
<p><strong>Implementation</strong>:</p>
<pre><code class="lang-powershell">$disabled = '${{ vars.NIGHTLY_DISABLED }}'
if ($disabled -eq 'true') {
  echo &quot;enabled=false&quot; &gt;&gt; $env:GITHUB_OUTPUT
}
</code></pre>
<p>All subsequent steps check: <code>if: steps.nightly_release_kill_switch.outputs.enabled == 'true'</code></p>
<h3 id="security-verification">Security Verification</h3>
<h4 id="repository-check">Repository Check</h4>
<p>Validates that workflow only runs on the correct repository:</p>
<pre><code class="lang-powershell">if ($env:GITHUB_REPOSITORY -ne 'Krypton-Suite/Standard-Toolkit') {
  Write-Error &quot;Security: Invalid repository&quot;
  exit 1
}
</code></pre>
<h4 id="branch-check">Branch Check</h4>
<p>Verifies workflow is running from an authorized branch:</p>
<pre><code class="lang-powershell">$allowedRefs = @('refs/heads/alpha', 'refs/heads/master', 'refs/heads/main')
if ($env:GITHUB_REF -notin $allowedRefs) {
  Write-Error &quot;Security: Unauthorized branch&quot;
  exit 1
}
</code></pre>
<p><strong>Note</strong>: Workflow checks out <code>alpha</code> branch regardless of trigger source.</p>
<h3 id="change-detection">Change Detection</h3>
<p><strong>Purpose</strong>: Skips build if no commits in last 24 hours</p>
<p><strong>Implementation</strong>:</p>
<pre><code class="lang-powershell">$yesterday = (Get-Date).AddDays(-1).ToUniversalTime().ToString(&quot;yyyy-MM-dd HH:mm:ss&quot;)
$commitCount = git rev-list --count --since=&quot;$yesterday&quot; alpha
</code></pre>
<p><strong>Logic</strong>:</p>
<ul>
<li>Counts commits on <code>alpha</code> branch since 24 hours ago</li>
<li>If count &gt; 0: proceeds with build</li>
<li>If count = 0: skips build and logs notice</li>
</ul>
<p><strong>Benefits</strong>:</p>
<ul>
<li>Saves CI minutes</li>
<li>Prevents duplicate packages</li>
<li>Reduces noise in notifications</li>
</ul>
<h3 id="net-sdk-setup">.NET SDK Setup</h3>
<p><strong>Versions Installed</strong>:</p>
<ul>
<li>.NET 9.0.x</li>
<li>.NET 10.0.x</li>
<li>.NET 11.0.x (optional, continues on error)</li>
</ul>
<p><strong>Special Handling</strong>:</p>
<ul>
<li>.NET 11 setup has <code>continue-on-error: true</code></li>
<li>Falls back gracefully if .NET 11 not available</li>
<li>Logs notice if .NET 11 setup fails</li>
</ul>
<p><strong>global.json Generation</strong>:</p>
<ul>
<li>Prefers .NET 10 SDK</li>
<li>Falls back to .NET 8 if .NET 10 unavailable</li>
<li>Uses <code>rollForward: latestFeature</code></li>
</ul>
<h3 id="build-process">Build Process</h3>
<p><strong>Project File</strong>: <code>Scripts/nightly.proj</code></p>
<p><strong>Configuration</strong>: <code>Nightly</code></p>
<p><strong>Platform</strong>: <code>Any CPU</code></p>
<p><strong>Targets</strong>:</p>
<ol>
<li><code>Build</code> - Compiles solution</li>
<li><code>Pack</code> - Creates NuGet packages</li>
</ol>
<p><strong>Output Location</strong>: <code>Bin/Packages/Nightly/</code></p>
<h3 id="nuget-publishing">NuGet Publishing</h3>
<p><strong>Process</strong>:</p>
<ol>
<li>Scans for <code>.nupkg</code> files in <code>Bin/Packages/Nightly/</code></li>
<li>Pushes each package to nuget.org</li>
<li>Uses <code>--skip-duplicate</code> flag to handle existing packages</li>
<li>Tracks if any packages were actually published</li>
</ol>
<p><strong>Package Detection</strong>:</p>
<pre><code class="lang-powershell">$packages = Get-ChildItem &quot;Bin/Packages/Nightly/*.nupkg&quot;
</code></pre>
<p><strong>Publishing Logic</strong>:</p>
<ul>
<li>Checks output for &quot;already exists&quot; or &quot;was not pushed&quot;</li>
<li>Only marks as published if package was new</li>
<li>Continues with remaining packages on individual failures</li>
</ul>
<p><strong>Required Secret</strong>: <code>NUGET_API_KEY</code></p>
<p><strong>Output Variable</strong>: <code>packages_published</code> (true/false)</p>
<h3 id="version-extraction">Version Extraction</h3>
<p><strong>Methods</strong> (in order of preference):</p>
<ol>
<li><p><strong>Assembly Version</strong> (Primary)</p>
<pre><code class="lang-powershell">$dllPath = Get-ChildItem &quot;Bin/Nightly/net48/Krypton.Toolkit.dll&quot;
$assemblyVersion = [System.Reflection.AssemblyName]::GetAssemblyName($dllPath.FullName).Version
</code></pre>
</li>
<li><p><strong>Project File</strong> (Fallback)</p>
<pre><code class="lang-powershell">[xml]$projXml = Get-Content &quot;Source/Krypton Components/Krypton.Toolkit/Krypton.Toolkit.csproj&quot;
$versionNode = $projXml.SelectSingleNode(&quot;//Version&quot;)
</code></pre>
</li>
<li><p><strong>Hardcoded Fallback</strong></p>
<ul>
<li>Version: <code>100.25.1.1</code></li>
<li>Tag: <code>v100.25.1.1-nightly</code></li>
</ul>
</li>
</ol>
<p><strong>Output Variables</strong>:</p>
<ul>
<li><code>version</code> - Version number (e.g., <code>100.25.1.1</code>)</li>
<li><code>tag</code> - Git tag format (e.g., <code>v100.25.1.1-nightly</code>)</li>
</ul>
<h3 id="discord-notification">Discord Notification</h3>
<p><strong>Trigger</strong>: Only if packages were published (<code>packages_published == 'True'</code>)</p>
<p><strong>Required Secret</strong>: <code>DISCORD_WEBHOOK_NIGHTLY</code></p>
<p><strong>Message Content</strong>:</p>
<ul>
<li>Title: &quot;ðŸš€ Krypton Toolkit Nightly Release&quot;</li>
<li>Version information</li>
<li>NuGet package links</li>
<li>Target frameworks list</li>
<li>Changelog link</li>
</ul>
<p><strong>Color</strong>: <code>10181046</code> (purple/blue)</p>
<p><strong>Packages Listed</strong>:</p>
<ul>
<li>Krypton.Toolkit.Nightly</li>
<li>Krypton.Ribbon.Nightly</li>
<li>Krypton.Navigator.Nightly</li>
<li>Krypton.Workspace.Nightly</li>
<li>Krypton.Docking.Nightly</li>
<li>Krypton.Standard.Toolkit.Nightly</li>
</ul>
<h2 id="configuration">Configuration</h2>
<h3 id="required-secrets">Required Secrets</h3>
<ul>
<li><p><strong><code>NUGET_API_KEY</code></strong>: API key for nuget.org publishing</p>
<ul>
<li>Get from: <a href="https://www.nuget.org/account/apikeys">https://www.nuget.org/account/apikeys</a></li>
<li>Requires &quot;Push&quot; permission</li>
</ul>
</li>
<li><p><strong><code>DISCORD_WEBHOOK_NIGHTLY</code></strong>: Discord webhook URL for notifications</p>
<ul>
<li>Create in Discord server settings</li>
<li>Optional (workflow continues if not set)</li>
</ul>
</li>
</ul>
<h3 id="required-variables">Required Variables</h3>
<ul>
<li><strong><code>NIGHTLY_DISABLED</code></strong>: Kill switch variable
<ul>
<li>Set to <code>true</code> to disable workflow</li>
<li>Set to <code>false</code> or leave unset to enable</li>
</ul>
</li>
</ul>
<h3 id="required-environments">Required Environments</h3>
<ul>
<li><strong><code>production</code></strong>: Protected environment
<ul>
<li>Requires approval before publishing</li>
<li>Prevents accidental releases</li>
<li>Configure in repository settings</li>
</ul>
</li>
</ul>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="workflow-not-running">Workflow Not Running</h3>
<p><strong>Possible Causes</strong>:</p>
<ol>
<li>Kill switch enabled (<code>NIGHTLY_DISABLED=true</code>)</li>
<li>No changes in last 24 hours (expected behavior)</li>
<li>Schedule not configured correctly</li>
<li>Workflow file syntax errors</li>
</ol>
<p><strong>Solutions</strong>:</p>
<ul>
<li>Check variable <code>NIGHTLY_DISABLED</code> in repository settings</li>
<li>Verify commits exist on <code>alpha</code> branch</li>
<li>Review workflow schedule syntax</li>
<li>Check Actions tab for errors</li>
</ul>
<h3 id="build-skipped-due-to-no-changes">Build Skipped Due to No Changes</h3>
<p><strong>Expected Behavior</strong>: This is intentional</p>
<p><strong>Reason</strong>: Saves resources when no new code exists</p>
<p><strong>Solution</strong>: Make a commit to <code>alpha</code> branch or manually trigger workflow</p>
<h3 id="nuget-publishing-failed">NuGet Publishing Failed</h3>
<p><strong>Possible Causes</strong>:</p>
<ol>
<li>Missing or invalid <code>NUGET_API_KEY</code></li>
<li>Package version already exists</li>
<li>Network issues</li>
<li>Invalid package format</li>
</ol>
<p><strong>Solutions</strong>:</p>
<ul>
<li>Verify API key is set and valid</li>
<li>Check if package version already exists (this is handled gracefully)</li>
<li>Review NuGet push logs</li>
<li>Verify package files are valid</li>
</ul>
<h3 id="discord-notification-not-sent">Discord Notification Not Sent</h3>
<p><strong>Possible Causes</strong>:</p>
<ol>
<li>No packages were published (expected if duplicates)</li>
<li>Missing <code>DISCORD_WEBHOOK_NIGHTLY</code> secret</li>
<li>Webhook URL invalid</li>
<li>Discord API issues</li>
</ol>
<p><strong>Solutions</strong>:</p>
<ul>
<li>Check <code>packages_published</code> output in logs</li>
<li>Verify webhook secret is set</li>
<li>Test webhook URL manually</li>
<li>Check Discord server settings</li>
</ul>
<h3 id="version-extraction-failed">Version Extraction Failed</h3>
<p><strong>Behavior</strong>: Uses fallback version <code>100.25.1.1</code></p>
<p><strong>Solutions</strong>:</p>
<ul>
<li>Verify build completed successfully</li>
<li>Check if DLL exists at expected path</li>
<li>Review version extraction logs</li>
<li>Ensure project file has <code>&lt;Version&gt;</code> element</li>
</ul>
<h3 id="net-11-setup-failed">.NET 11 Setup Failed</h3>
<p><strong>Expected Behavior</strong>: This is normal if .NET 11 is not yet available</p>
<p><strong>Solution</strong>: Workflow continues with .NET 10 (this is intentional)</p>
<h2 id="related-workflows">Related Workflows</h2>
<ul>
<li><strong>Build Workflow</strong>: Similar build process for CI</li>
<li><strong>Release Workflow</strong>: Similar publishing process for stable releases</li>
</ul>
<h2 id="code-reference">Code Reference</h2>
<p><strong>File</strong>: <code>.github/workflows/nightly.yml</code></p>
<p><strong>Key Components</strong>:</p>
<ul>
<li>Event: <code>schedule</code> and <code>workflow_dispatch</code></li>
<li>Environment: <code>production</code></li>
<li>Concurrency: <code>nightly-alpha</code> group</li>
<li>Kill Switch: <code>NIGHTLY_DISABLED</code> variable</li>
</ul>
<h2 id="maintenance-notes">Maintenance Notes</h2>
<h3 id="updating-schedule">Updating Schedule</h3>
<p>To change the build schedule:</p>
<pre><code class="lang-yaml">schedule:
  - cron: '0 0 * * *'  # Change cron expression
</code></pre>
<p><strong>Common Schedules</strong>:</p>
<ul>
<li><code>0 0 * * *</code> - Daily at midnight UTC</li>
<li><code>0 */6 * * *</code> - Every 6 hours</li>
<li><code>0 0 * * 1</code> - Weekly on Monday</li>
</ul>
<h3 id="modifying-change-detection-window">Modifying Change Detection Window</h3>
<p>To change the 24-hour window:</p>
<pre><code class="lang-powershell">$yesterday = (Get-Date).AddHours(-24).AddDays(-1)  # Change hours
</code></pre>
<h3 id="adding-new-packages">Adding New Packages</h3>
<p>If new NuGet packages are added:</p>
<ol>
<li>Update Discord notification message</li>
<li>Verify package paths in publishing step</li>
<li>Test package creation in build step</li>
</ol>
<h3 id="kill-switch-management">Kill Switch Management</h3>
<p><strong>To Disable</strong>:</p>
<ol>
<li>Go to Repository Settings â†’ Secrets and variables â†’ Actions</li>
<li>Add/Edit variable: <code>NIGHTLY_DISABLED</code> = <code>true</code></li>
<li>Save</li>
</ol>
<p><strong>To Re-enable</strong>:</p>
<ol>
<li>Set <code>NIGHTLY_DISABLED</code> = <code>false</code></li>
<li>Or delete the variable</li>
</ol>
<h2 id="best-practices">Best Practices</h2>
<ol>
<li><strong>Monitor Builds</strong>: Check Actions tab regularly for failures</li>
<li><strong>Version Management</strong>: Ensure version numbers increment correctly</li>
<li><strong>Change Detection</strong>: Let the workflow skip when appropriate</li>
<li><strong>Kill Switch</strong>: Use for maintenance or emergency stops</li>
<li><strong>Notifications</strong>: Keep Discord webhook updated</li>
<li><strong>Security</strong>: Never commit secrets or API keys</li>
</ol>
<h2 id="workflow-flow-diagram">Workflow Flow Diagram</h2>
<pre><code>Schedule Trigger (00:00 UTC)
    â”‚
    â”œâ”€&gt; Kill Switch Check
    â”‚   â””â”€&gt; If disabled: Exit
    â”‚
    â”œâ”€&gt; Security Verification
    â”‚   â”œâ”€&gt; Repository Check
    â”‚   â””â”€&gt; Branch Check
    â”‚
    â”œâ”€&gt; Checkout alpha Branch
    â”‚
    â”œâ”€&gt; Change Detection (24h)
    â”‚   â””â”€&gt; If no changes: Skip &amp; Exit
    â”‚
    â”œâ”€&gt; Setup .NET SDKs (9, 10, 11)
    â”‚
    â”œâ”€&gt; Setup Build Tools (MSBuild, NuGet)
    â”‚
    â”œâ”€&gt; Restore &amp; Build
    â”‚
    â”œâ”€&gt; Pack NuGet Packages
    â”‚
    â”œâ”€&gt; Publish to nuget.org
    â”‚   â””â”€&gt; If published: Continue
    â”‚   â””â”€&gt; If skipped: Exit (no notification)
    â”‚
    â”œâ”€&gt; Extract Version
    â”‚
    â””â”€&gt; Discord Notification (if published)
</code></pre>

</article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      <span>Krypton Component Suite 2024
BSD 3-Clause License
Â© Component Factory Pty Ltd, 2006 - 2016, All rights reserved.</span> <span>Modifications by Peter Wagner (aka Wagnerp), Simon Coghlan (aka Smurf-IV), Giduac, Tobitege, Lesarndro, KamaniAR & Ahmed Abdelhameed et al. 2017 - 2025. All rights reserved. <a href="https://github.com/Krypton-Suite">https://github.com/Krypton-Suite</a></span>
      
          </div>
        </div>
      </footer>
    </div>

    <script type="text/javascript" src="../../../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../styles/main.js"></script>
  </body>
</html>
