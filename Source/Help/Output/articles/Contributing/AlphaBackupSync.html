<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>Alpha to Alpha-Backup Sync (GitHub Actions) | Krypton Standard Toolkit Documentation </title>
      <meta name="viewport" content="width=device-width">
      <meta name="title" content="Alpha to Alpha-Backup Sync (GitHub Actions) | Krypton Standard Toolkit Documentation ">
    
    
      <link rel="shortcut icon" href="../../Krypton.ico">
      <link rel="stylesheet" href="../../styles/docfx.vendor.min.css">
      <link rel="stylesheet" href="../../styles/docfx.css">
      <link rel="stylesheet" href="../../styles/main.css">
      <meta property="docfx:navrel" content="../../toc.html">
      <meta property="docfx:tocrel" content="../toc.html">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../Logo.png" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="alpha-to-alpha-backup-sync-github-actions">Alpha to Alpha-Backup Sync (GitHub Actions)</h1>

<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#overview">Overview</a></li>
<li><a href="#key-features">Key Features</a></li>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#triggers">Triggers</a></li>
<li><a href="#setup">Setup</a></li>
<li><a href="#workflow-logic-step-by-step">Workflow Logic (Step by Step)</a></li>
<li><a href="#discord-notifications">Discord Notifications</a></li>
<li><a href="#automating-the-merge-auto-merge">Automating the Merge (Auto-Merge)</a></li>
<li><a href="#security-and-permissions">Security and Permissions</a></li>
<li><a href="#edge-cases-and-behaviour">Edge Cases and Behaviour</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#see-also">See Also</a></li>
</ol>
<hr>
<h2 id="overview">Overview</h2>
<p>The <strong>Alpha to Alpha-Backup Sync</strong> workflow is a GitHub Actions automation that keeps a backup of the <code>alpha</code> branch by creating a pull request from <code>alpha</code> into <code>alpha-backup</code> whenever <code>alpha</code> has received commits in the last 24 hours. It runs at midnight UTC (or on manual trigger) and, when appropriate, ensures the <code>alpha-backup</code> branch exists, opens or reuses a PR from <code>alpha</code> to <code>alpha-backup</code>, and optionally sends a Discord notification.</p>
<h3 id="purpose">Purpose</h3>
<ul>
<li><strong>Backup</strong>: Maintain a separate branch (<code>alpha-backup</code>) that can be updated via a PR, giving visibility and optional review before the backup is updated.</li>
<li><strong>Automation</strong>: No manual copying of <code>alpha</code>; the workflow detects recent activity and proposes the sync via a PR.</li>
<li><strong>Visibility</strong>: Optional Discord notifications when a sync run detects changes and creates or finds an open PR.</li>
</ul>
<h3 id="architecture-high-level">Architecture (High Level)</h3>
<ol>
<li><strong>Trigger</strong>: Schedule (midnight UTC) or manual.</li>
<li><strong>Check</strong>: Count commits on <code>alpha</code> in the last 24 hours.</li>
<li><strong>If no recent commits</strong>: Workflow exits without creating branches or PRs.</li>
<li><strong>If recent commits exist</strong>:
<ul>
<li>Ensure <code>alpha-backup</code> exists (create it from <code>alpha</code> if it does not).</li>
<li>Compare <code>alpha-backup</code> with <code>alpha</code>; if <code>alpha</code> is ahead, create an open PR from <code>alpha</code> into <code>alpha-backup</code> (or reuse an existing one).</li>
<li>Optionally send a Discord notification with branch/PR and run details.</li>
</ul>
</li>
</ol>
<p>The actual “copy” of <code>alpha</code> onto <code>alpha-backup</code> happens when that PR is merged (manually or via auto-merge).</p>
<hr>
<h2 id="key-features">Key Features</h2>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>24-hour window</strong></td>
<td>Only acts when <code>alpha</code> has at least one commit in the last 24 hours.</td>
</tr>
<tr>
<td><strong>Branch creation</strong></td>
<td>Creates <code>alpha-backup</code> from current <code>alpha</code> if the branch does not exist.</td>
</tr>
<tr>
<td><strong>PR-based sync</strong></td>
<td>Sync is proposed via a PR (base: <code>alpha-backup</code>, head: <code>alpha</code>), not a direct push.</td>
</tr>
<tr>
<td><strong>No duplicate PRs</strong></td>
<td>Reuses an existing open PR from <code>alpha</code> → <code>alpha-backup</code> instead of opening another.</td>
</tr>
<tr>
<td><strong>No no-op PRs</strong></td>
<td>Does not open a PR when <code>alpha-backup</code> is already up to date with <code>alpha</code>.</td>
</tr>
<tr>
<td><strong>Discord (optional)</strong></td>
<td>Can post a summary to Discord when changes are detected; requires a webhook secret.</td>
</tr>
<tr>
<td><strong>Manual run</strong></td>
<td>Can be triggered from the Actions tab via <strong>Run workflow</strong>.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="requirements">Requirements</h2>
<ul>
<li><strong>Repository</strong>: GitHub repository containing an <code>alpha</code> branch.</li>
<li><strong>Permissions</strong>: Workflow needs <code>contents: write</code> and <code>pull-requests: write</code> (see <a href="#security-and-permissions">Security and Permissions</a>).</li>
<li><strong>Discord (optional)</strong>: A Discord webhook URL stored as a repository secret if you want notifications.</li>
</ul>
<hr>
<h2 id="triggers">Triggers</h2>
<table>
<thead>
<tr>
<th>Trigger</th>
<th>When</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Schedule</strong></td>
<td>Daily at <strong>00:00 UTC</strong> (<code>cron: '0 0 * * *'</code>).</td>
</tr>
<tr>
<td><strong>Manual</strong></td>
<td><strong>Actions</strong> → <strong>Alpha to Alpha-Backup Sync</strong> → <strong>Run workflow</strong> → <strong>Run workflow</strong>.</td>
</tr>
</tbody>
</table>
<p>Scheduled runs are subject to <a href="https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule">GitHub Actions schedule limits</a>; if the repository is inactive, scheduled workflows may not run every day.</p>
<hr>
<h2 id="setup">Setup</h2>
<h3 id="1-workflow-file">1. Workflow file</h3>
<p>The workflow is defined in:</p>
<pre><code>.github/workflows/alpha-backup-sync.yml
</code></pre>
<p>No code changes are required for basic operation once the file is in the default branch and the repo has Actions enabled.</p>
<h3 id="2-branch-protection-optional">2. Branch protection (optional)</h3>
<p>If <code>alpha-backup</code> is protected:</p>
<ul>
<li>The workflow uses <code>GITHUB_TOKEN</code>, which respects branch protection. Ensure the token can push to <code>alpha-backup</code> (e.g. allow Actions to bypass or use a PAT with appropriate permissions if you switch to a different token).</li>
<li>If you use <strong>Require a pull request before merging</strong>, the workflow’s PR can be merged after review or via auto-merge.</li>
</ul>
<h3 id="3-discord-optional">3. Discord (optional)</h3>
<p>To enable Discord notifications:</p>
<ol>
<li>In your Discord server, create an <strong>Incoming Webhook</strong> (Channel → Integrations → Webhooks).</li>
<li>Copy the webhook URL.</li>
<li>In the repo: <strong>Settings</strong> → <strong>Secrets and variables</strong> → <strong>Actions</strong> → <strong>Secrets</strong>.</li>
<li>Add a new repository secret:
<ul>
<li><strong>Name</strong>: <code>DISCORD_WEBHOOK_ALPHA_BACKUP</code></li>
<li><strong>Value</strong>: the Discord webhook URL</li>
</ul>
</li>
</ol>
<p>If this secret is not set, the workflow still runs but skips the Discord step without failing.</p>
<hr>
<h2 id="workflow-logic-step-by-step">Workflow Logic (Step by Step)</h2>
<h3 id="step-1-checkout">Step 1: Checkout</h3>
<ul>
<li><strong>Action</strong>: <code>actions/checkout@v6</code></li>
<li><strong>Ref</strong>: <code>alpha</code></li>
<li><strong>fetch-depth</strong>: <code>0</code> (full history for <code>git rev-list --since</code>).</li>
</ul>
<p>The job runs on <code>ubuntu-latest</code> and has full clone of <code>alpha</code>.</p>
<h3 id="step-2-check-for-changes-on-alpha-in-last-24-hours">Step 2: Check for changes on alpha in last 24 hours</h3>
<ul>
<li><strong>Id</strong>: <code>check_changes</code></li>
<li><strong>Logic</strong>:
<ul>
<li>Computes a timestamp for “24 hours ago” in UTC.</li>
<li>Runs: <code>git rev-list --count --since=&quot;&lt;timestamp&gt;&quot; alpha</code>.</li>
<li>If count &gt; 0: sets output <code>has_changes=true</code>; otherwise <code>has_changes=false</code>.</li>
</ul>
</li>
</ul>
<p>All subsequent steps that create the branch, create/find the PR, or send Discord run only when <code>has_changes == 'true'</code>.</p>
<h3 id="step-3-ensure-alpha-backup-exists">Step 3: Ensure alpha-backup exists</h3>
<ul>
<li><strong>Id</strong>: <code>ensure_backup</code></li>
<li><strong>Runs when</strong>: <code>steps.check_changes.outputs.has_changes == 'true'</code></li>
<li><strong>Tool</strong>: <code>actions/github-script@v8</code> (GitHub REST/API).</li>
<li><strong>Logic</strong>:
<ol>
<li>Call <code>repos.getBranch</code> for <code>alpha-backup</code>.</li>
<li>If the branch exists: log and return <code>'exists'</code>.</li>
<li>If the branch does not exist (404):
<ul>
<li>Get the SHA of <code>refs/heads/alpha</code> via <code>git.getRef</code>.</li>
<li>Create <code>refs/heads/alpha-backup</code> pointing at that SHA via <code>git.createRef</code>.</li>
<li>Log and return <code>'created'</code>.</li>
</ul>
</li>
</ol>
</li>
<li><strong>Output</strong>: <code>steps.ensure_backup.outputs.result</code> is either <code>'exists'</code> or <code>'created'</code>.</li>
</ul>
<p>This guarantees <code>alpha-backup</code> exists before the PR step. On first run, <code>alpha-backup</code> is created as a copy of <code>alpha</code> at that moment.</p>
<h3 id="step-4-create-pr-from-alpha-to-alpha-backup">Step 4: Create PR from alpha to alpha-backup</h3>
<ul>
<li><strong>Id</strong>: <code>create_pr</code></li>
<li><strong>Runs when</strong>: <code>steps.check_changes.outputs.has_changes == 'true'</code></li>
<li><strong>Tool</strong>: <code>actions/github-script@v8</code>.</li>
<li><strong>Logic</strong>:
<ol>
<li><strong>Compare</strong>: <code>repos.compareCommitsWithBasehead</code> with <code>basehead: 'alpha-backup...alpha'</code> (commits in <code>alpha</code> not in <code>alpha-backup</code>).</li>
<li>If <code>ahead_by === 0</code>: log “no PR needed”, return <code>{ pr_created: false, pr_number: '', pr_url: '' }</code>.</li>
<li><strong>Existing PR</strong>: <code>pulls.list</code> with <code>state: 'open'</code>, <code>head: '&lt;owner&gt;:alpha'</code>, <code>base: 'alpha-backup'</code>. If any open PR exists: use its number and <code>html_url</code>, return them in the result object (no new PR).</li>
<li><strong>New PR</strong>: <code>pulls.create</code> with base <code>alpha-backup</code>, head <code>alpha</code>, fixed title/body. Return <code>{ pr_created: true, pr_number, pr_url }</code>.</li>
</ol>
</li>
<li><strong>Output</strong>: <code>steps.create_pr.outputs.result</code> is a JSON object with <code>pr_created</code>, <code>pr_number</code>, and <code>pr_url</code> (used by Discord).</li>
</ul>
<p>So: a PR is only created when <code>alpha</code> is ahead of <code>alpha-backup</code> and there is no open PR from <code>alpha</code> → <code>alpha-backup</code> already.</p>
<h3 id="step-5-discord-notification">Step 5: Discord notification</h3>
<ul>
<li><strong>Runs when</strong>: <code>steps.check_changes.outputs.has_changes == 'true'</code></li>
<li><strong>Behaviour</strong>:
<ul>
<li>If <code>DISCORD_WEBHOOK_ALPHA_BACKUP</code> is not set: log and exit 0 (no failure).</li>
<li>Otherwise: build a Discord embed payload with:
<ul>
<li>Title: “Alpha → Alpha-Backup Sync”</li>
<li>Description: states that alpha had commits in the last 24 hours; whether <code>alpha-backup</code> was created or already existed; link to the PR (if any); link to the workflow run.</li>
</ul>
</li>
<li>POST the payload to the webhook with <code>curl</code>.</li>
</ul>
</li>
</ul>
<p>Branch-created vs already-existed is derived from <code>steps.ensure_backup.outputs.result == 'created'</code>. PR link comes from parsing <code>steps.create_pr.outputs.result</code> (e.g. with <code>jq</code>) for <code>pr_url</code> and <code>pr_number</code>.</p>
<hr>
<h2 id="discord-notifications">Discord Notifications</h2>
<h3 id="when-a-notification-is-sent">When a notification is sent</h3>
<ul>
<li>Only when <strong>alpha had at least one commit in the last 24 hours</strong> (<code>has_changes == 'true'</code>).</li>
<li>Only if the repository secret <strong><code>DISCORD_WEBHOOK_ALPHA_BACKUP</code></strong> is set.</li>
</ul>
<h3 id="what-the-message-contains">What the message contains</h3>
<ul>
<li><strong>Title</strong>: “Alpha → Alpha-Backup Sync”</li>
<li><strong>Description</strong> (summary):
<ul>
<li>That alpha had commits in the last 24 hours.</li>
<li>Whether <code>alpha-backup</code> was created (did not exist) or already existed.</li>
<li>A link to the PR (if one exists or was just created).</li>
<li>A link to the workflow run.</li>
</ul>
</li>
<li><strong>Footer</strong>: “Alpha Backup Sync”</li>
<li><strong>Colour</strong>: Blue (3447003).</li>
</ul>
<h3 id="using-the-same-channel-as-nightly">Using the same channel as Nightly</h3>
<p>You can reuse the same Discord channel as the nightly workflow by pointing <code>DISCORD_WEBHOOK_ALPHA_BACKUP</code> to the same webhook URL as <code>DISCORD_WEBHOOK_NIGHTLY</code>, or use a different webhook for a different channel.</p>
<hr>
<h2 id="automating-the-merge-auto-merge">Automating the Merge (Auto-Merge)</h2>
<p>The workflow only <strong>opens</strong> (or finds) the PR; it does not merge it. To make the backup update automatically:</p>
<ol>
<li>In the repo: <strong>Settings</strong> → <strong>General</strong> → <strong>Pull Requests</strong> → enable <strong>Allow auto-merge</strong>.</li>
<li>When the workflow opens a PR “chore: sync alpha → alpha-backup (automated)”:
<ul>
<li>Open the PR.</li>
<li>Click <strong>Enable auto-merge</strong> and choose merge method (merge commit, squash, rebase) and conditions (e.g. “Merge when branch is up to date” or when checks pass, if you add required status checks).</li>
</ul>
</li>
</ol>
<p>After that, each time the workflow opens a sync PR, it can be merged automatically so <code>alpha-backup</code> stays in sync with <code>alpha</code> without manual merge clicks.</p>
<hr>
<h2 id="security-and-permissions">Security and Permissions</h2>
<h3 id="workflow-permissions">Workflow permissions</h3>
<p>The workflow declares:</p>
<pre><code class="lang-yaml">permissions:
  contents: write   # Create/update refs (e.g. create alpha-backup)
  pull-requests: write   # Create and read PRs
</code></pre>
<ul>
<li><strong>contents: write</strong>: Needed to create the <code>alpha-backup</code> branch via the Git/Refs API when it does not exist.</li>
<li><strong>pull-requests: write</strong>: Needed to list and create pull requests.</li>
</ul>
<h3 id="token">Token</h3>
<p>The job uses the default <strong><code>GITHUB_TOKEN</code></strong> provided by the Actions runner. It is scoped to the repository and respects branch protection and repo rules. No Personal Access Token or other secrets are required for core behaviour.</p>
<h3 id="what-the-workflow-does-not-do">What the workflow does not do</h3>
<ul>
<li>It does not push directly to <code>alpha</code> or any other branch except by creating the ref for <code>alpha-backup</code> when missing.</li>
<li>It does not delete branches or force-push.</li>
<li>It does not merge the PR; merging is done by a user or by auto-merge.</li>
</ul>
<hr>
<h2 id="edge-cases-and-behaviour">Edge Cases and Behaviour</h2>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Behaviour</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>alpha-backup does not exist</strong></td>
<td>Branch is created from current <code>alpha</code> SHA. No PR is created (alpha and alpha-backup are identical). Discord (if configured) reports that the branch was created.</td>
</tr>
<tr>
<td><strong>alpha-backup exists, alpha is ahead</strong></td>
<td>An open PR from <code>alpha</code> → <code>alpha-backup</code> is created (or reused if one already exists). Discord can include the PR link.</td>
</tr>
<tr>
<td><strong>alpha-backup exists and is up to date with alpha</strong></td>
<td>No PR is created. Discord still runs (if webhook set) and reports that alpha had recent commits; PR link may be empty if no open PR.</td>
</tr>
<tr>
<td><strong>Open PR already exists</strong></td>
<td>No second PR; the existing PR’s number and URL are used in the script output and can appear in Discord.</td>
</tr>
<tr>
<td><strong>No commits on alpha in last 24 hours</strong></td>
<td>All steps after “Check for changes” are skipped. No branch creation, no PR, no Discord.</td>
</tr>
<tr>
<td><strong>Manual run with no recent commits</strong></td>
<td>Same as above: no branch/PR/Discord.</td>
</tr>
<tr>
<td><strong>Scheduled run skipped by GitHub</strong></td>
<td>If the repo is inactive, GitHub may skip scheduled runs; use manual run to test.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="workflow-does-not-run-at-midnight">Workflow does not run at midnight</h3>
<ul>
<li>Confirm the workflow file is on the default branch and that Actions are enabled.</li>
<li>Check <strong>Actions</strong> → <strong>Alpha to Alpha-Backup Sync</strong> for run history. GitHub can skip scheduled runs for inactive repos; trigger manually to verify.</li>
</ul>
<h3 id="alpha-backup-was-not-created">alpha-backup was not created</h3>
<ul>
<li>Ensure the job has <strong>contents: write</strong> and that branch protection or rules do not block creation of <code>alpha-backup</code> by the <code>GITHUB_TOKEN</code>.</li>
<li>Check the “Ensure alpha-backup exists” step log for API errors (e.g. 403).</li>
</ul>
<h3 id="no-pr-is-created-even-though-alpha-has-new-commits">No PR is created even though alpha has new commits</h3>
<ul>
<li>Verify “Check for changes” reports <code>has_changes=true</code> and “Create PR” step runs.</li>
<li>In “Create PR”, check the compare result: if <code>ahead_by === 0</code>, no PR is opened (e.g. first run after creating <code>alpha-backup</code> from <code>alpha</code>).</li>
<li>If an open PR from <code>alpha</code> → <code>alpha-backup</code> already exists, the workflow reuses it and does not open a second one.</li>
</ul>
<h3 id="discord-notification-not-received">Discord notification not received</h3>
<ul>
<li>Confirm the repository secret <strong><code>DISCORD_WEBHOOK_ALPHA_BACKUP</code></strong> is set and that the workflow run had <code>has_changes == 'true'</code>.</li>
<li>Check the “Discord notification” step log for “DISCORD_WEBHOOK_ALPHA_BACKUP not set” or HTTP errors from the webhook.</li>
</ul>
<h3 id="how-to-test-without-waiting-for-midnight">How to test without waiting for midnight</h3>
<p>Use <strong>Actions</strong> → <strong>Alpha to Alpha-Backup Sync</strong> → <strong>Run workflow</strong> → <strong>Run workflow</strong>. Ensure <code>alpha</code> has at least one commit in the last 24 hours if you want to test branch creation, PR creation, and Discord.</p>
<hr>
<h2 id="see-also">See Also</h2>
<ul>
<li><strong>Workflow file</strong>: <a href="../.github/workflows/alpha-backup-sync.yml">.github/workflows/alpha-backup-sync.yml</a></li>
<li><strong>Nightly workflow</strong> (also uses 24-hour change check and Discord): <a href="../.github/workflows/nightly.yml">.github/workflows/nightly.yml</a></li>
<li><a href="https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule">GitHub: Events that trigger workflows – schedule</a></li>
<li><a href="https://docs.github.com/en/actions/security-guides/automatic-token-authentication">GitHub: Using the GITHUB_TOKEN</a></li>
</ul>

</article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      <span>Krypton Component Suite 2024
BSD 3-Clause License
© Component Factory Pty Ltd, 2006 - 2016, All rights reserved.</span> <span>Modifications by Peter Wagner (aka Wagnerp), Simon Coghlan (aka Smurf-IV), Giduac, Tobitege, Lesarndro, KamaniAR & Ahmed Abdelhameed et al. 2017 - 2025. All rights reserved. <a href="https://github.com/Krypton-Suite">https://github.com/Krypton-Suite</a></span>
      
          </div>
        </div>
      </footer>
    </div>

    <script type="text/javascript" src="../../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
